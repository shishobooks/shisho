#!/bin/bash
set -e

# Get repo name from git remote
get_repo_name() {
    git remote get-url origin 2>/dev/null | sed 's/.*[/:]\([^/]*\)\.git$/\1/' | sed 's/.*[/:]\([^/]*\)$/\1/'
}

# Check if we're in a tmux session
if [ -z "$TMUX" ]; then
    echo "Error: Must be run inside a tmux session"
    exit 1
fi

# Get repo root and name
REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null)
if [ -z "$REPO_ROOT" ]; then
    echo "Error: Not in a git repository"
    exit 1
fi

REPO_NAME=$(get_repo_name)
if [ -z "$REPO_NAME" ]; then
    echo "Error: Could not determine repository name from git remote"
    exit 1
fi

# Generate or use provided task name
if [ -n "$1" ]; then
    TASK_NAME="$1"
else
    RANDOM_CHARS=$(LC_ALL=C tr -dc 'a-z' < /dev/urandom | head -c 3)
    TIMESTAMP=$(date +%Y%m%d-%H%M%S)
    TASK_NAME="${RANDOM_CHARS}-${TIMESTAMP}"
fi

BRANCH_NAME="task/$TASK_NAME"
WORKTREE_BASE="$HOME/.worktrees/$REPO_NAME"
WORKTREE_DIR="$WORKTREE_BASE/$TASK_NAME"

# Create worktree base directory if it doesn't exist
mkdir -p "$WORKTREE_BASE"

# Create the worktree
echo "Creating worktree at $WORKTREE_DIR..."
git worktree add "$WORKTREE_DIR" -b "$BRANCH_NAME"

# Create tmux window with 3 evenly-sized vertical panes
echo "Opening tmux window..."
tmux new-window -d -n "$TASK_NAME" -c "$WORKTREE_DIR"

# Calculate pane sizes for 3 equal panes
WINDOW_HEIGHT=$(tmux display-message -t "$TASK_NAME" -p "#{window_height}")
TWO_THIRDS_SIZE=$((WINDOW_HEIGHT * 66 / 100))
HALF_SIZE=$((TWO_THIRDS_SIZE / 2))

# Split to create bottom 66%, leaving top 33%
tmux split-window -d -v -l "$TWO_THIRDS_SIZE" -t "${TASK_NAME}.0" -c "$WORKTREE_DIR"
# Split the bottom pane in half to create middle and bottom panes (each 33%)
tmux split-window -d -v -l "$HALF_SIZE" -t "${TASK_NAME}.1" -c "$WORKTREE_DIR"

# Pane layout:
#   Pane 0 (top): claude
#   Pane 1 (middle): make start (pre-typed, not executed)
#   Pane 2 (bottom): other commands / make setup
tmux send-keys -t "${TASK_NAME}.2" "make setup" Enter
tmux send-keys -t "${TASK_NAME}.1" "make start"
tmux send-keys -t "${TASK_NAME}.0" "claude --dangerously-skip-permissions" Enter
tmux select-window -t "$TASK_NAME"
tmux select-pane -t "${TASK_NAME}.0"

echo "Task '$TASK_NAME' started in new tmux window"
