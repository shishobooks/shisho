#!/bin/bash
set -e

# Get repo name from git remote
get_repo_name() {
    git remote get-url origin 2>/dev/null | sed 's/.*[/:]\([^/]*\)\.git$/\1/' | sed 's/.*[/:]\([^/]*\)$/\1/'
}

# Get current task from directory path
get_current_task() {
    local repo_name=$(get_repo_name)
    local worktree_base="$HOME/.worktrees/$repo_name"
    local cwd=$(pwd)

    if [[ "$cwd" == "$worktree_base/"* ]]; then
        echo "${cwd#$worktree_base/}" | cut -d'/' -f1
    fi
}

# Get repo root and name
REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null)
if [ -z "$REPO_ROOT" ]; then
    echo "Error: Not in a git repository"
    exit 1
fi

REPO_NAME=$(get_repo_name)
if [ -z "$REPO_NAME" ]; then
    echo "Error: Could not determine repository name from git remote"
    exit 1
fi

# Get task name from argument or current directory
if [ -n "$1" ]; then
    TASK_NAME="$1"
else
    TASK_NAME=$(get_current_task)
    if [ -z "$TASK_NAME" ]; then
        echo "Error: No task name provided and not in a worktree directory"
        echo "Usage: task-apply [task-name]"
        exit 1
    fi
fi

BRANCH_NAME="task/$TASK_NAME"
WORKTREE_BASE="$HOME/.worktrees/$REPO_NAME"
WORKTREE_DIR="$WORKTREE_BASE/$TASK_NAME"

# Verify the worktree exists
if [ ! -d "$WORKTREE_DIR" ]; then
    echo "Error: Worktree directory not found: $WORKTREE_DIR"
    exit 1
fi

# Get the main repo worktree (where master lives)
MAIN_WORKTREE=$(git worktree list | grep -v "$WORKTREE_BASE" | head -1 | awk '{print $1}')
if [ -z "$MAIN_WORKTREE" ]; then
    echo "Error: Could not find main repository worktree"
    exit 1
fi

echo "Applying task '$TASK_NAME' to master..."

# Change to main worktree
cd "$MAIN_WORKTREE"

# Fetch and update master
echo "Updating master..."
git fetch origin
git checkout master
git pull origin master

# Squash merge the task branch
echo "Squash merging $BRANCH_NAME..."
if ! git merge --squash "$BRANCH_NAME"; then
    echo ""
    echo "Merge conflicts detected. To resolve:"
    echo "  1. Fix conflicts in the files listed above"
    echo "  2. git add <resolved-files>"
    echo "  3. git commit"
    echo "  4. Run: ./scripts/task-cancel $TASK_NAME"
    echo "     (to clean up the worktree and branch)"
    exit 1
fi

# Commit with editor
echo "Opening editor for commit message..."
git commit

# Clean up worktree and branch
echo "Cleaning up..."
git worktree remove "$WORKTREE_DIR"
git branch -D "$BRANCH_NAME"

echo "Task '$TASK_NAME' successfully applied to master"
